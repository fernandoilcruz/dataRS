---
title: "dataRS_examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dataRS_examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

#dataRS package examples

Now that you have already walked through the dataRS_at_a_glance vignette (if you have not, I recommend it), let’s explore a few examples that illustrate the use of the package in economic analysis applications for the state of Rio Grande do Sul.

But first, let's load some useful libraries.

```{r setup}
library(dataRS)
library(tidyverse)
library(geobr)
library(gganimate)
library(magick)
```


## Example 1 - Municipal diffusion of soybean crop losses over time

```{r warning = FALSE, message = FALSE, results = FALSE, echo = TRUE}
soy_id <-
  dataRS::vars() |>
  dplyr::filter(stringr::str_detect(var_name,"Soja") & stringr::str_detect(var_name,"Rendimento")) |>
  dplyr::select(var_id) |>
  dplyr::pull()

data_soy_mun <-
  dataRS::getdata(var_id = soy_id,
                  ag = "municipio",
                  period = "all",
                  add_labels = TRUE) |>
  group_by(geo_id) |>
  dplyr::mutate(
    `percent change` = 100*((value-dplyr::lag(value))/(dplyr::lag(value)))
  )

data_soy_state <-
  dataRS::getdata(var_id = soy_id,
                  ag = "estado",
                  period = "all",
                  add_labels = TRUE) |>
  group_by(geo_id) |>
  dplyr::mutate(
    `percent change` = 100*((value-dplyr::lag(value))/(dplyr::lag(value)))
  )
  
```


```{r warning = FALSE, message = FALSE, results = TRUE, echo = TRUE}
map_rs_mapa <-
  geobr::read_municipality(
    code_muni = "RS",
    year = 2020
  )

anos <- data_soy_mun |> select(year) |> pull() |> unique()

lista <- list()
for(i in 1:length(anos)){
  lista[[i]] <-
    map_rs_mapa |>
    mutate(year = anos[i])
}

map_rs_mapa2 <- lista |> map_df(bind_rows)


map_rs <-
  map_rs_mapa2 |>
  dplyr::left_join(
    data_soy_mun,
    by = c("code_muni" = "geo_id",
           "year" = "year")
  )




# p_map1 <- 
#   map_rs |>
#   ggplot() +
#   geom_sf( 
#           aes(fill = `percent change`), 
#           color = "lightgray", 
#           size = .15) +
#   labs(title = "Var. % do Rendimento Médio da Produção de Soja",
#        caption = 'Fonte: DataRS', size = 8) +
#   # scale_fill_distiller(palette = "RdYlGn",
#   #                      name = "Var. % do Rendimento",
#   #                      breaks = c(-50, -25, -10, 10, 25, 50),
#   #                      direction = "horizontal") +
# scale_fill_stepsn(
#   name = "Var. % do Rendimento",
#   breaks = c(-50, -25, 0, 25, 50),
#   colours = c("#D7191C", "#FDAE61", "#FFFFBF", "#A6D96A", "#1A9641"),
#   #limits = c(-50, 50)
# ) +
#   gganimate::transition_manual(year) +
#   labs( title = "Ano: {current_frame}") +
#   # transition_states(Ano,transition_length = 10, state_length = 1) +
#   # labs(title = "Ano: {closest_state}") +
#   # transition_time(as.integer(Ano)) +
#   # labs(title = "Ano: {as.integer(frame_time)}") +
#   theme_minimal()



p_map1 <-
  map_rs |>
  ggplot() +
  geom_sf(
    aes(
      fill = 
        cut(
        `percent change`,
        breaks = c(-Inf, -25, 0, 25, Inf),
        labels = c("< -25%", "-25% a 0%", "0% a 25%", "> 25%"),
        right = TRUE
      ) |>
        forcats::fct_rev()
    ),
    color = "lightgray",
    size = 0.15
  ) +
  labs(
    title = "Var. % do Rendimento Médio da Produção de Soja",
    caption = "Fonte: DataRS",
    fill = "Var. % do Rendimento"
  ) +
  scale_fill_manual(
    values = c(
      "> 25%" = "#A6D96A",
      "0% a 25%" =  "#FFFFBF",
      "-25% a 0%" = "#FDAE61",
      "< -25%" = "#D7191C"
    ),
    na.value = "gray95"
  ) +
  gganimate::transition_manual(year) +
  labs(title = "Ano: {current_frame}") +
  theme_minimal()
  


p_anim1 <- animate(p_map1,
                   nframes = 500,
                   #duration = 20,
                   renderer = gifski_renderer())




rend_estado <- 
  data_soy_state |>
  ggplot(
    aes(x = year,
        y = `percent change`
        )
  ) +
  geom_line(colour = "darkblue",
            alpha = 0.5,
            size = 1) +
  geom_point(colour = "darkblue") +
  ggtitle("Rendimento da produção de soja no Rio Grande do Sul") +
  gganimate::transition_reveal(year) +
  theme_minimal()

p_anim2 <- animate(rend_estado,
                   #nframes = 31,
                   nframes = 500,
                   #duration = 20,
                   renderer = gifski_renderer())

a_mgif <- image_read(p_anim1)
b_mgif <- image_read(p_anim2)


new_gif <- image_append(c(a_mgif[1], b_mgif[1]), stack = FALSE)
for(i in 2:500){
  combined <- image_append(c(a_mgif[i], b_mgif[i]), stack = FALSE)
  new_gif <- c(new_gif, combined)
}
new_gif

```


